<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Attendance App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input { margin: 5px; padding: 5px; }
    button { padding: 5px 10px; margin-top: 10px; }
    #qr-code { margin-top: 20px; }
    video, canvas { width: 300px; height: 300px; border: 1px solid #ccc; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>QR Attendance App</h1>

  <!-- Generate QR -->
  <div>
    <h2>Generate QR Code</h2>
    <input type="text" id="id" placeholder="Enter ID" />
    <input type="text" id="name" placeholder="Enter Name" />
    <button onclick="generateQR()">Generate QR</button>
    <div id="qr-code"></div>
  </div>

  <hr>

  <!-- Scan QR -->
  <div>
    <h2>Scan QR Code</h2>
    <video id="video" autoplay></video>
    <canvas id="canvas" hidden></canvas>
    <p><strong>Scanned Data:</strong> <span id="result">No result yet</span></p>
    <input type="file" id="fileInput" accept="image/*" />
  </div>

  <hr>

  <!-- Attendance Download -->
  <div>
    <h2>Download Attendance</h2>
    <button id="downloadBtn">Download Attendance (TXT)</button>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
    // QR Generation
    let qrCode = new QRCodeStyling({ width: 200, height: 200 });
    const qrDiv = document.getElementById("qr-code");
    function generateQR() {
      const id = document.getElementById("id").value;
      const name = document.getElementById("name").value;
      if (!id || !name) { alert("Enter both ID and Name"); return; }
      qrCode.update({ data: `ID:${id},Name:${name}` });
      qrDiv.innerHTML = "";
      qrCode.append(qrDiv);
    }

    // QR Scanning via Camera
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const resultSpan = document.getElementById("result");
    const ctx = canvas.getContext("2d");

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => { console.log("Camera not accessible:", err); });

    let attendanceLog = []; // Store scanned attendance

    video.addEventListener("play", () => {
      const scan = () => {
        if (video.paused || video.ended) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          resultSpan.textContent = code.data;
          // Add to attendance log if new
          if (!attendanceLog.find(a => a.data === code.data)) {
            const parts = code.data.split(",");
            const idPart = parts[0].split(":")[1];
            const namePart = parts[1].split(":")[1];
            attendanceLog.push({ id: idPart, name: namePart, data: code.data });
          }
        }
        requestAnimationFrame(scan);
      };
      scan();
    });

    // QR Scanning via File Upload
    const fileInput = document.getElementById("fileInput");
    fileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          resultSpan.textContent = code.data;
          if (!attendanceLog.find(a => a.data === code.data)) {
            const parts = code.data.split(",");
            const idPart = parts[0].split(":")[1];
            const namePart = parts[1].split(":")[1];
            attendanceLog.push({ id: idPart, name: namePart, data: code.data });
          }
        } else resultSpan.textContent = "No QR code found";
      };
      img.src = URL.createObjectURL(file);
    });

    // Attendance Download as TXT
    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (attendanceLog.length === 0) {
        alert("No attendance data available");
        return;
      }
      const txtContent = ["ID\tName", ...attendanceLog.map(a => `${a.id}\t${a.name}`)].join("\n");
      const blob = new Blob([txtContent], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "attendance_log.txt";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
